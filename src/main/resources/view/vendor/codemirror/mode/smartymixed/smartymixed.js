!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../smarty/smarty")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../smarty/smarty"],t):t(CodeMirror)}(function(CodeMirror){"use strict";CodeMirror.defineMode("smartymixed",function(t){function e(t){return t.replace(/[^\s\w]/g,"\\$&")}var l=CodeMirror.getMode(t,"htmlmixed"),i=CodeMirror.getMode(t,"smarty"),a={rightDelimiter:"}",leftDelimiter:"{"};t.hasOwnProperty("leftDelimiter")&&(a.leftDelimiter=t.leftDelimiter),t.hasOwnProperty("rightDelimiter")&&(a.rightDelimiter=t.rightDelimiter);var r=e(a.leftDelimiter),n=e(a.rightDelimiter),o={smartyComment:new RegExp("^"+n+"\\*"),literalOpen:new RegExp(r+"literal"+n),literalClose:new RegExp(r+"/literal"+n),hasLeftDelimeter:new RegExp(".*"+r),htmlHasLeftDelimeter:new RegExp("[^<>]*"+r)},m={chain:function(t,e,l){return e.tokenize=l,l(t,e)},cleanChain:function(t,e,l){return e.tokenize=null,e.localState=null,e.localMode=null,"string"==typeof l?l?l:null:l(t,e)},maybeBackup:function(t,e,l){var i,a=t.current(),r=a.search(e);return r>-1?t.backUp(a.length-r):(i=a.match(/<\/?$/))&&(t.backUp(a.length),t.match(e,!1)||t.match(a[0])),l}},c={html:function(t,e){var r=e.htmlMixedState.htmlState.context&&e.htmlMixedState.htmlState.context.tagName?e.htmlMixedState.htmlState.context.tagName:null;return!e.inLiteral&&t.match(o.htmlHasLeftDelimeter,!1)&&null===r?(e.tokenize=c.smarty,e.localMode=i,e.localState=i.startState(l.indent(e.htmlMixedState,"")),m.maybeBackup(t,a.leftDelimiter,i.token(t,e.localState))):!e.inLiteral&&t.match(a.leftDelimiter,!1)?(e.tokenize=c.smarty,e.localMode=i,e.localState=i.startState(l.indent(e.htmlMixedState,"")),m.maybeBackup(t,a.leftDelimiter,i.token(t,e.localState))):l.token(t,e.htmlMixedState)},smarty:function(t,e){if(t.match(a.leftDelimiter,!1)){if(t.match(o.smartyComment,!1))return m.chain(t,e,c.inBlock("comment","*"+a.rightDelimiter))}else if(t.match(a.rightDelimiter,!1))return t.eat(a.rightDelimiter),e.tokenize=c.html,e.localMode=l,e.localState=e.htmlMixedState,"tag";return m.maybeBackup(t,a.rightDelimiter,i.token(t,e.localState))},inBlock:function(t,e){return function(l,i){for(;!l.eol();){if(l.match(e)){m.cleanChain(l,i,"");break}l.next()}return t}}};return{startState:function(){var t=l.startState();return{token:c.html,localMode:null,localState:null,htmlMixedState:t,tokenize:null,inLiteral:!1}},copyState:function(t){var e=null,a=t.tokenize||t.token;return t.localState&&(e=CodeMirror.copyState(a!=c.html?i:l,t.localState)),{token:t.token,tokenize:t.tokenize,localMode:t.localMode,localState:e,htmlMixedState:CodeMirror.copyState(l,t.htmlMixedState),inLiteral:t.inLiteral}},token:function(t,e){if(t.match(a.leftDelimiter,!1)){if(!e.inLiteral&&t.match(o.literalOpen,!0))return e.inLiteral=!0,"keyword";if(e.inLiteral&&t.match(o.literalClose,!0))return e.inLiteral=!1,"keyword"}e.inLiteral&&e.localState!=e.htmlMixedState&&(e.tokenize=c.html,e.localMode=l,e.localState=e.htmlMixedState);var i=(e.tokenize||e.token)(t,e);return i},indent:function(t,e){return t.localMode==i||t.inLiteral&&!t.localMode||o.hasLeftDelimeter.test(e)?CodeMirror.Pass:l.indent(t.htmlMixedState,e)},innerMode:function(t){return{state:t.localState||t.htmlMixedState,mode:t.localMode||l}}}},"htmlmixed","smarty"),CodeMirror.defineMIME("text/x-smarty","smartymixed")});