!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],t):t(CodeMirror)}(function(CodeMirror){"use strict";var t=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];CodeMirror.defineMode("soy",function(e){function n(t){return t[t.length-1]}function a(t,e,n){var a=t.string,i=n.exec(a.substr(t.pos));i&&(t.string=a.substr(0,t.pos+i.index));var l=t.hideFirstChars(e.indent,function(){return e.localMode.token(t,e.localState)});return t.string=a,l}var i=CodeMirror.getMode(e,"text/plain"),l={html:CodeMirror.getMode(e,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1}),attributes:i,text:i,uri:i,css:CodeMirror.getMode(e,"text/css"),js:CodeMirror.getMode(e,{name:"text/javascript",statementIndent:2*e.indentUnit})};return{startState:function(){return{kind:[],kindTag:[],soyState:[],indent:0,localMode:l.html,localState:CodeMirror.startState(l.html)}},copyState:function(t){return{tag:t.tag,kind:t.kind.concat([]),kindTag:t.kindTag.concat([]),soyState:t.soyState.concat([]),indent:t.indent,localMode:t.localMode,localState:CodeMirror.copyState(t.localMode,t.localState)}},token:function(i,o){var s;switch(n(o.soyState)){case"comment":return i.match(/^.*?\*\//)?o.soyState.pop():i.skipToEnd(),"comment";case"variable":return i.match(/^}/)?(o.indent-=2*e.indentUnit,o.soyState.pop(),"variable-2"):(i.next(),null);case"tag":if(i.match(/^\/?}/))return"/template"==o.tag||"/deltemplate"==o.tag?o.indent=0:o.indent-=("/}"==i.current()||t.indexOf(o.tag)==-1?2:1)*e.indentUnit,o.soyState.pop(),"keyword";if(i.match(/^(\w+)(?==)/)){if("kind"==i.current()&&(s=i.match(/^="([^"]+)/,!1))){var r=s[1];o.kind.push(r),o.kindTag.push(o.tag),o.localMode=l[r]||l.html,o.localState=CodeMirror.startState(o.localMode)}return"attribute"}return i.match(/^"/)?(o.soyState.push("string"),"string"):(i.next(),null);case"literal":return i.match(/^(?=\{\/literal})/)?(o.indent-=e.indentUnit,o.soyState.pop(),this.token(i,o)):a(i,o,/\{\/literal}/);case"string":return i.match(/^.*?"/)?o.soyState.pop():i.skipToEnd(),"string"}return i.match(/^\/\*/)?(o.soyState.push("comment"),"comment"):i.match(i.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/)?"comment":i.match(/^\{\$\w*/)?(o.indent+=2*e.indentUnit,o.soyState.push("variable"),"variable-2"):i.match(/^\{literal}/)?(o.indent+=e.indentUnit,o.soyState.push("literal"),"keyword"):(s=i.match(/^\{([\/@\\]?\w*)/))?("/switch"!=s[1]&&(o.indent+=(/^(\/|(else|elseif|case|default)$)/.test(s[1])&&"switch"!=o.tag?1:2)*e.indentUnit),o.tag=s[1],o.tag=="/"+n(o.kindTag)&&(o.kind.pop(),o.kindTag.pop(),o.localMode=l[n(o.kind)]||l.html,o.localState=CodeMirror.startState(o.localMode)),o.soyState.push("tag"),"keyword"):a(i,o,/\{|\s+\/\/|\/\*/)},indent:function(t,a){var i=t.indent,l=n(t.soyState);if("comment"==l)return CodeMirror.Pass;if("literal"==l)/^\{\/literal}/.test(a)&&(i-=e.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(a))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(a)&&(i-=e.indentUnit),"switch"!=t.tag&&/^\{(case|default)\b/.test(a)&&(i-=e.indentUnit),/^\{\/switch\b/.test(a)&&(i-=e.indentUnit)}return i&&t.localMode.indent&&(i+=t.localMode.indent(t.localState,a)),i},innerMode:function(t){return t.soyState.length&&"literal"!=n(t.soyState)?null:{state:t.localState,mode:t.localMode}},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",fold:"indent"}},"htmlmixed"),CodeMirror.registerHelper("hintWords","soy",t.concat(["delpackage","namespace","alias","print","css","debugger"])),CodeMirror.defineMIME("text/x-soy","soy")});