!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],t):t(CodeMirror)}(function(CodeMirror){"use strict";CodeMirror.defineMode("slim",function(t){function e(t,e,n){var i=function(i,r){return r.tokenize=e,i.pos<t?(i.pos=t,n):r.tokenize(i,r)};return function(t,n){return n.tokenize=i,e(t,n)}}function n(t,n,i,r,o){var u=t.current(),a=u.search(i);return a>-1&&(n.tokenize=e(t.pos,n.tokenize,o),t.backUp(u.length-a-r)),o}function i(t,e){t.stack={parent:t.stack,style:"continuation",indented:e,tokenize:t.line},t.line=t.tokenize}function r(t){t.line==t.tokenize&&(t.line=t.stack.tokenize,t.stack=t.stack.parent)}function o(t,e){return function(n,o){if(r(o),n.match(/^\\$/))return i(o,t),"lineContinuation";var u=e(n,o);return n.eol()&&n.current().match(/(?:^|[^\\])(?:\\\\)*\\$/)&&n.backUp(1),u}}function u(t,e){return function(n,o){r(o);var u=e(n,o);return n.eol()&&n.current().match(/,$/)&&i(o,t),u}}function a(t,e){return function(n,i){var r=n.peek();return r==t&&1==i.rubyState.tokenize.length?(n.next(),i.tokenize=e,"closeAttributeTag"):l(n,i)}}function c(t){var e,n=function(n,i){if(1==i.rubyState.tokenize.length&&!i.rubyState.context.prev){if(n.backUp(1),n.eatSpace())return i.rubyState=e,i.tokenize=t,t(n,i);n.next()}return l(n,i)};return function(t,i){return e=i.rubyState,i.rubyState=P.startState(),i.tokenize=n,l(t,i)}}function l(t,e){return P.token(t,e.rubyState)}function s(t,e){return t.match(/^\\$/)?"lineContinuation":k(t,e)}function k(t,e){return t.match(/^#\{/)?(e.tokenize=a("}",e.tokenize),null):n(t,e,/[^\\]#\{/,1,I.token(t,e.htmlState))}function d(t){return function(e,n){var i=s(e,n);return e.eol()&&(n.tokenize=t),i}}function m(t,e,n){return e.stack={parent:e.stack,style:"html",indented:t.column()+n,tokenize:e.line},e.line=e.tokenize=k,null}function f(t,e){return t.skipToEnd(),e.stack.style}function b(t,e){return e.stack={parent:e.stack,style:"comment",indented:e.indented+1,tokenize:e.line},e.line=f,f(t,e)}function z(t,e){return t.eat(e.stack.endQuote)?(e.line=e.stack.line,e.tokenize=e.stack.tokenize,e.stack=e.stack.parent,null):t.match(J)?(e.tokenize=p,"slimAttribute"):(t.next(),null)}function p(t,e){return t.match(/^==?/)?(e.tokenize=x,null):z(t,e)}function x(t,e){var n=t.peek();return'"'==n||"'"==n?(e.tokenize=R(n,"string",!0,!1,z),t.next(),e.tokenize(t,e)):"["==n?c(z)(t,e):t.match(/^(true|false|nil)\b/)?(e.tokenize=z,"keyword"):c(z)(t,e)}function h(t,e,n){return t.stack={parent:t.stack,style:"wrapper",indented:t.indented+1,tokenize:n,line:t.line,endQuote:e},t.line=t.tokenize=z,null}function y(t,e){if(t.match(/^#\{/))return e.tokenize=a("}",e.tokenize),null;var n=new CodeMirror.StringStream(t.string.slice(e.stack.indented),t.tabSize);n.pos=t.pos-e.stack.indented,n.start=t.start-e.stack.indented,n.lastColumnPos=t.lastColumnPos-e.stack.indented,n.lastColumnValue=t.lastColumnValue-e.stack.indented;var i=e.subMode.token(n,e.subState);return t.pos=n.pos+e.stack.indented,i}function S(t,e){return e.stack.indented=t.column(),e.line=e.tokenize=y,e.tokenize(t,e)}function v(e){var n=_[e],i=CodeMirror.mimeModes[n];if(i)return CodeMirror.getMode(t,i);var r=CodeMirror.modes[n];return r?r(t,{name:n}):CodeMirror.getMode(t,"null")}function w(t){return Z.hasOwnProperty(t)?Z[t]:Z[t]=v(t)}function g(t,e){var n=w(t),i=n.startState&&n.startState();return e.subMode=n,e.subState=i,e.stack={parent:e.stack,style:"sub",indented:e.indented+1,tokenize:e.line},e.line=e.tokenize=S,"slimSubmode"}function M(t,e){return t.skipToEnd(),"slimDoctype"}function C(t,e){var n=t.peek();if("<"==n)return(e.tokenize=d(e.tokenize))(t,e);if(t.match(/^[|']/))return m(t,e,1);if(t.match(/^\/(!|\[\w+])?/))return b(t,e);if(t.match(/^(-|==?[<>]?)/))return e.tokenize=o(t.column(),u(t.column(),l)),"slimSwitch";if(t.match(/^doctype\b/))return e.tokenize=M,"keyword";var i=t.match(D);return i?g(i[1],e):A(t,e)}function E(t,e){return e.startOfLine?C(t,e):A(t,e)}function A(t,e){return t.eat("*")?(e.tokenize=c(L),null):t.match(G)?(e.tokenize=L,"slimTag"):$(t,e)}function L(t,e){return t.match(/^(<>?|><?)/)?(e.tokenize=$,null):$(t,e)}function $(t,e){return t.match(N)?(e.tokenize=$,"slimId"):t.match(K)?(e.tokenize=$,"slimClass"):T(t,e)}function T(t,e){return t.match(/^([\[\{\(])/)?h(e,V[RegExp.$1],T):t.match(H)?(e.tokenize=U,"slimAttribute"):"*"==t.peek()?(t.next(),e.tokenize=c(q),null):q(t,e)}function U(t,e){return t.match(/^==?/)?(e.tokenize=j,null):T(t,e)}function j(t,e){var n=t.peek();return'"'==n||"'"==n?(e.tokenize=R(n,"string",!0,!1,T),t.next(),e.tokenize(t,e)):"["==n?c(T)(t,e):":"==n?c(O)(t,e):t.match(/^(true|false|nil)\b/)?(e.tokenize=T,"keyword"):c(T)(t,e)}function O(t,e){return t.backUp(1),t.match(/^[^\s],(?=:)/)?(e.tokenize=c(O),null):(t.next(),T(t,e))}function R(t,e,n,o,u){return function(c,l){r(l);var s=0==c.current().length;if(c.match(/^\\$/,s))return s?(i(l,l.indented),"lineContinuation"):e;if(c.match(/^#\{/,s))return s?(l.tokenize=a("}",l.tokenize),null):e;for(var k,d=!1;null!=(k=c.next());){if(k==t&&(o||!d)){l.tokenize=u;break}if(n&&"#"==k&&!d&&c.eat("{")){c.backUp(2);break}d=!d&&"\\"==k}return c.eol()&&d&&c.backUp(1),e}}function q(t,e){return t.match(/^==?/)?(e.tokenize=l,"slimSwitch"):t.match(/^\/$/)?(e.tokenize=E,null):t.match(/^:/)?(e.tokenize=A,"slimSwitch"):(m(t,e,0),e.tokenize(t,e))}var I=CodeMirror.getMode(t,{name:"htmlmixed"}),P=CodeMirror.getMode(t,"ruby"),Z={html:I,ruby:P},_={ruby:"ruby",javascript:"javascript",css:"text/css",sass:"text/x-sass",scss:"text/x-scss",less:"text/x-less",styl:"text/x-styl",coffee:"coffeescript",asciidoc:"text/x-asciidoc",markdown:"text/x-markdown",textile:"text/x-textile",creole:"text/x-creole",wiki:"text/x-wiki",mediawiki:"text/x-mediawiki",rdoc:"text/x-rdoc",builder:"text/x-builder",nokogiri:"text/x-nokogiri",erb:"application/x-erb"},D=function(t){var e=[];for(var n in t)e.push(n);return new RegExp("^("+e.join("|")+"):")}(_),Q={commentLine:"comment",slimSwitch:"operator special",slimTag:"tag",slimId:"attribute def",slimClass:"attribute qualifier",slimAttribute:"attribute",slimSubmode:"keyword special",closeAttributeTag:null,slimDoctype:null,lineContinuation:null},V={"{":"}","[":"]","(":")"},B="_a-zA-ZÀ-ÖØ-öø-˿Ͱ-ͽͿ-῿‌-‍⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�",F=B+"\\-0-9·̀-ͯ‿-⁀",G=new RegExp("^[:"+B+"](?::["+F+"]|["+F+"]*)"),H=new RegExp("^[:"+B+"][:\\."+F+"]*(?=\\s*=)"),J=new RegExp("^[:"+B+"][:\\."+F+"]*"),K=/^\.-?[_a-zA-Z]+[\w\-]*/,N=/^#[_a-zA-Z]+[\w\-]*/,W={startState:function(){var t=I.startState(),e=P.startState();return{htmlState:t,rubyState:e,stack:null,last:null,tokenize:E,line:E,indented:0}},copyState:function(t){return{htmlState:CodeMirror.copyState(I,t.htmlState),rubyState:CodeMirror.copyState(P,t.rubyState),subMode:t.subMode,subState:t.subMode&&CodeMirror.copyState(t.subMode,t.subState),stack:t.stack,last:t.last,tokenize:t.tokenize,line:t.line}},token:function(t,e){if(t.sol())for(e.indented=t.indentation(),e.startOfLine=!0,e.tokenize=e.line;e.stack&&e.stack.indented>e.indented&&"slimSubmode"!=e.last;)e.line=e.tokenize=e.stack.tokenize,e.stack=e.stack.parent,e.subMode=null,e.subState=null;if(t.eatSpace())return null;var n=e.tokenize(t,e);return e.startOfLine=!1,n&&(e.last=n),Q.hasOwnProperty(n)?Q[n]:n},blankLine:function(t){if(t.subMode&&t.subMode.blankLine)return t.subMode.blankLine(t.subState)},innerMode:function(t){return t.subMode?{state:t.subState,mode:t.subMode}:{state:t,mode:W}}};return W},"htmlmixed","ruby"),CodeMirror.defineMIME("text/x-slim","slim"),CodeMirror.defineMIME("application/x-slim","slim")});