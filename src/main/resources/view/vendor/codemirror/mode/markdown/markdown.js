!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../xml/xml"),require("../meta")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../xml/xml","../meta"],t):t(CodeMirror)}(function(CodeMirror){"use strict";CodeMirror.defineMode("markdown",function(t,e){function i(e){if(CodeMirror.findModeByName){var i=CodeMirror.findModeByName(e);i&&(e=i.mime||i.mimes[0])}var n=CodeMirror.getMode(t,e);return"null"==n.name?null:n}function n(t,e,i){return e.f=e.inline=i,i(t,e)}function r(t,e,i){return e.f=e.block=i,i(t,e)}function a(t){return t.linkTitle=!1,t.em=!1,t.strong=!1,t.strikethrough=!1,t.quote=0,S||t.f!=l||(t.f=u,t.block=o),t.trailingSpace=0,t.trailingSpaceNewLine=!1,t.thisLineHasContent=!1,null}function o(t,r){var a=t.sol(),o=r.list!==!1;r.list!==!1&&r.indentationDiff>=0?(r.indentationDiff<4&&(r.indentation-=r.indentationDiff),r.list=null):r.list!==!1&&r.indentation>0?(r.list=null,r.listDepth=Math.floor(r.indentation/4)):r.list!==!1&&(r.list=!1,r.listDepth=0);var l=null;if(r.indentationDiff>=4)return r.indentation-=4,t.skipToEnd(),q;if(t.eatSpace())return null;if(l=t.match(I))return r.header=l[0].length<=6?l[0].length:6,e.highlightFormatting&&(r.formatting="header"),r.f=r.inline,s(r);if(r.prevLineHasContent&&(l=t.match(P)))return r.header="="==l[0].charAt(0)?1:2,e.highlightFormatting&&(r.formatting="header"),r.f=r.inline,s(r);if(t.eat(">"))return r.indentation++,r.quote=a?1:r.quote+1,e.highlightFormatting&&(r.formatting="quote"),t.eatSpace(),s(r);if("["===t.peek())return n(t,r,k);if(t.match(W,!0))return H;if((!r.prevLineHasContent||o)&&(t.match(U,!1)||t.match(R,!1))){var g=null;return t.match(U,!0)?g="ul":(t.match(R,!0),g="ol"),r.indentation+=4,r.list=!0,r.listDepth++,e.taskLists&&t.match(A,!1)&&(r.taskList=!0),r.f=r.inline,e.highlightFormatting&&(r.formatting=["list","list-"+g]),s(r)}return e.fencedCodeBlocks&&t.match(/^```[ \t]*([\w+#]*)/,!0)?(r.localMode=i(RegExp.$1),r.localMode&&(r.localState=r.localMode.startState()),r.f=r.block=h,e.highlightFormatting&&(r.formatting="code-block"),r.code=!0,s(r)):n(t,r,r.inline)}function l(t,e){var i=L.token(t,e.htmlState);return(S&&null===e.htmlState.tagStart&&!e.htmlState.context||e.md_inside&&t.current().indexOf(">")>-1)&&(e.f=u,e.block=o,e.htmlState=null),i}function h(t,e){return t.sol()&&t.match("```",!1)?(e.localMode=e.localState=null,e.f=e.block=g,null):e.localMode?e.localMode.token(t,e.localState):(t.skipToEnd(),q)}function g(t,i){t.match("```"),i.block=o,i.f=u,e.highlightFormatting&&(i.formatting="code-block"),i.code=!0;var n=s(i);return i.code=!1,n}function s(t){var i=[];if(t.formatting){i.push(B),"string"==typeof t.formatting&&(t.formatting=[t.formatting]);for(var n=0;n<t.formatting.length;n++)i.push(B+"-"+t.formatting[n]),"header"===t.formatting[n]&&i.push(B+"-"+t.formatting[n]+"-"+t.header),"quote"===t.formatting[n]&&(!e.maxBlockquoteDepth||e.maxBlockquoteDepth>=t.quote?i.push(B+"-"+t.formatting[n]+"-"+t.quote):i.push("error"))}if(t.taskOpen)return i.push("meta"),i.length?i.join(" "):null;if(t.taskClosed)return i.push("property"),i.length?i.join(" "):null;if(t.linkHref)return i.push(N),i.length?i.join(" "):null;if(t.strong&&i.push(j),t.em&&i.push(O),t.strikethrough&&i.push(E),t.linkText&&i.push($),t.code&&i.push(q),t.header&&(i.push(b),i.push(b+"-"+t.header)),t.quote&&(i.push(M),!e.maxBlockquoteDepth||e.maxBlockquoteDepth>=t.quote?i.push(M+"-"+t.quote):i.push(M+"-"+e.maxBlockquoteDepth)),t.list!==!1){var r=(t.listDepth-1)%3;r?1===r?i.push(C):i.push(D):i.push(w)}return t.trailingSpaceNewLine?i.push("trailing-space-new-line"):t.trailingSpace&&i.push("trailing-space-"+(t.trailingSpace%2?"a":"b")),i.length?i.join(" "):null}function f(t,e){if(t.match(z,!0))return s(e)}function u(t,i){var n=i.text(t,i);if("undefined"!=typeof n)return n;if(i.list)return i.list=null,s(i);if(i.taskList){var a="x"!==t.match(A,!0)[1];return a?i.taskOpen=!0:i.taskClosed=!0,e.highlightFormatting&&(i.formatting="task"),i.taskList=!1,s(i)}if(i.taskOpen=!1,i.taskClosed=!1,i.header&&t.match(/^#+$/,!0))return e.highlightFormatting&&(i.formatting="header"),s(i);var o=t.sol(),h=t.next();if("\\"===h&&(t.next(),e.highlightFormatting)){var g=s(i);return g?g+" formatting-escape":"formatting-escape"}if(i.linkTitle){i.linkTitle=!1;var f=h;"("===h&&(f=")"),f=(f+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var u="^\\s*(?:[^"+f+"\\\\]+|\\\\\\\\|\\\\.)"+f;if(t.match(new RegExp(u),!0))return N}if("`"===h){var d=i.formatting;e.highlightFormatting&&(i.formatting="code");var k=s(i),p=t.pos;t.eatWhile("`");var v=1+t.pos-p;return i.code?v===F?(i.code=!1,k):(i.formatting=d,s(i)):(F=v,i.code=!0,s(i))}if(i.code)return s(i);if("!"===h&&t.match(/\[[^\]]*\] ?(?:\(|\[)/,!1))return t.match(/\[[^\]]*\]/),i.inline=i.f=c,T;if("["===h&&t.match(/.*\](\(.*\)| ?\[.*\])/,!1))return i.linkText=!0,e.highlightFormatting&&(i.formatting="link"),s(i);if("]"===h&&i.linkText&&t.match(/\(.*\)| ?\[.*\]/,!1)){e.highlightFormatting&&(i.formatting="link");var g=s(i);return i.linkText=!1,i.inline=i.f=c,g}if("<"===h&&t.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,!1)){i.f=i.inline=m,e.highlightFormatting&&(i.formatting="link");var g=s(i);return g?g+=" ":g="",g+y}if("<"===h&&t.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,!1)){i.f=i.inline=m,e.highlightFormatting&&(i.formatting="link");var g=s(i);return g?g+=" ":g="",g+_}if("<"===h&&t.match(/^\w/,!1)){if(t.string.indexOf(">")!=-1){var x=t.string.substring(1,t.string.indexOf(">"));/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(x)&&(i.md_inside=!0)}return t.backUp(1),i.htmlState=CodeMirror.startState(L),r(t,i,l)}if("<"===h&&t.match(/^\/\w*?>/))return i.md_inside=!1,"tag";var S=!1;if(!e.underscoresBreakWords&&"_"===h&&"_"!==t.peek()&&t.match(/(\w)/,!1)){var b=t.pos-2;if(b>=0){var q=t.string.charAt(b);"_"!==q&&q.match(/(\w)/,!1)&&(S=!0)}}if("*"===h||"_"===h&&!S)if(o&&" "===t.peek());else{if(i.strong===h&&t.eat(h)){e.highlightFormatting&&(i.formatting="strong");var k=s(i);return i.strong=!1,k}if(!i.strong&&t.eat(h))return i.strong=h,e.highlightFormatting&&(i.formatting="strong"),s(i);if(i.em===h){e.highlightFormatting&&(i.formatting="em");var k=s(i);return i.em=!1,k}if(!i.em)return i.em=h,e.highlightFormatting&&(i.formatting="em"),s(i)}else if(" "===h&&(t.eat("*")||t.eat("_"))){if(" "===t.peek())return s(i);t.backUp(1)}if(e.strikethrough)if("~"===h&&t.eatWhile(h)){if(i.strikethrough){e.highlightFormatting&&(i.formatting="strikethrough");var k=s(i);return i.strikethrough=!1,k}if(t.match(/^[^\s]/,!1))return i.strikethrough=!0,e.highlightFormatting&&(i.formatting="strikethrough"),s(i)}else if(" "===h&&t.match(/^~~/,!0)){if(" "===t.peek())return s(i);t.backUp(2)}return" "===h&&(t.match(/ +$/,!1)?i.trailingSpace++:i.trailingSpace&&(i.trailingSpaceNewLine=!0)),s(i)}function m(t,i){var n=t.next();if(">"===n){i.f=i.inline=u,e.highlightFormatting&&(i.formatting="link");var r=s(i);return r?r+=" ":r="",r+y}return t.match(/^[^>]+/,!0),y}function c(t,i){if(t.eatSpace())return null;var n=t.next();return"("===n||"["===n?(i.f=i.inline=d("("===n?")":"]"),e.highlightFormatting&&(i.formatting="link-string"),i.linkHref=!0,s(i)):"error"}function d(t){return function(i,n){var r=i.next();if(r===t){n.f=n.inline=u,e.highlightFormatting&&(n.formatting="link-string");var a=s(n);return n.linkHref=!1,a}return i.match(x(t),!0)&&i.backUp(1),n.linkHref=!0,s(n)}}function k(t,i){return t.match(/^[^\]]*\]:/,!1)?(i.f=p,t.next(),e.highlightFormatting&&(i.formatting="link"),i.linkText=!0,s(i)):n(t,i,u)}function p(t,i){if(t.match(/^\]:/,!0)){i.f=i.inline=v,e.highlightFormatting&&(i.formatting="link");var n=s(i);return i.linkText=!1,n}return t.match(/^[^\]]+/,!0),$}function v(t,e){return t.eatSpace()?null:(t.match(/^[^\s]+/,!0),void 0===t.peek()?e.linkTitle=!0:t.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,!0),e.f=e.inline=u,N)}function x(t){return G[t]||(t=(t+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),G[t]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+t+")")),G[t]}var S=CodeMirror.modes.hasOwnProperty("xml"),L=CodeMirror.getMode(t,S?{name:"xml",htmlMode:!0}:"text/plain");void 0===e.highlightFormatting&&(e.highlightFormatting=!1),void 0===e.maxBlockquoteDepth&&(e.maxBlockquoteDepth=0),void 0===e.underscoresBreakWords&&(e.underscoresBreakWords=!0),void 0===e.fencedCodeBlocks&&(e.fencedCodeBlocks=!1),void 0===e.taskLists&&(e.taskLists=!1),void 0===e.strikethrough&&(e.strikethrough=!1);var F=0,b="header",q="comment",M="quote",w="variable-2",C="variable-3",D="keyword",H="hr",T="tag",B="formatting",y="link",_="link",$="link",N="string",O="em",j="strong",E="strikethrough",W=/^([*\-=_])(?:\s*\1){2,}\s*$/,U=/^[*\-+]\s+/,R=/^[0-9]+\.\s+/,A=/^\[(x| )\](?=\s)/,I=/^#+/,P=/^(?:\={1,}|-{1,})$/,z=/^[^#!\[\]*_\\<>` "'(~]+/,G=[],J={startState:function(){return{f:o,prevLineHasContent:!1,thisLineHasContent:!1,block:o,htmlState:null,indentation:0,inline:u,text:f,formatting:!1,linkText:!1,linkHref:!1,linkTitle:!1,em:!1,strong:!1,header:0,taskList:!1,list:!1,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:!1,strikethrough:!1}},copyState:function(t){return{f:t.f,prevLineHasContent:t.prevLineHasContent,thisLineHasContent:t.thisLineHasContent,block:t.block,htmlState:t.htmlState&&CodeMirror.copyState(L,t.htmlState),indentation:t.indentation,localMode:t.localMode,localState:t.localMode?CodeMirror.copyState(t.localMode,t.localState):null,inline:t.inline,text:t.text,formatting:!1,linkTitle:t.linkTitle,em:t.em,strong:t.strong,strikethrough:t.strikethrough,header:t.header,taskList:t.taskList,list:t.list,listDepth:t.listDepth,quote:t.quote,trailingSpace:t.trailingSpace,trailingSpaceNewLine:t.trailingSpaceNewLine,md_inside:t.md_inside}},token:function(t,e){if(e.formatting=!1,t.sol()){var i=!!e.header;if(e.header=0,t.match(/^\s*$/,!0)||i)return e.prevLineHasContent=!1,a(e),i?this.token(t,e):null;e.prevLineHasContent=e.thisLineHasContent,e.thisLineHasContent=!0,e.taskList=!1,e.code=!1,e.trailingSpace=0,e.trailingSpaceNewLine=!1,e.f=e.block;var n=t.match(/^\s*/,!0)[0].replace(/\t/g,"    ").length,r=4*Math.floor((n-e.indentation)/4);r>4&&(r=4);var o=e.indentation+r;if(e.indentationDiff=o-e.indentation,e.indentation=o,n>0)return null}return e.f(t,e)},innerMode:function(t){return t.block==l?{state:t.htmlState,mode:L}:t.localState?{state:t.localState,mode:t.localMode}:{state:t,mode:J}},blankLine:a,getType:s,fold:"markdown"};return J},"xml"),CodeMirror.defineMIME("text/x-markdown","markdown")});